# Ralph Progress Log

## Completed Tasks

### US-001: Create project structure [x]
- Created src/ folder with submodules: environment, agents, training, field, analysis
- All __init__.py files in place
- `python -c "import src"` works

### US-003: Create base config dataclasses [x]
- Created src/configs.py with all config dataclasses
- EnvConfig, FieldConfig, AgentConfig, TrainConfig, LogConfig, AnalysisConfig, Config
- Config.from_yaml() and to_yaml() implemented
- Typecheck passes

### US-002: Set up dependencies and virtual environment [x]
- Verified scripts/setup.sh creates venv, installs deps, verifies JAX
- Fixed mypy errors in src/configs.py: renamed `field` import to `dataclass_field` to avoid name collision with Config.field attribute
- Added types-PyYAML to dev dependencies in pyproject.toml
- Fixed `to_dict` type annotation and AgentConfig construction for mypy compliance
- All acceptance criteria pass: setup.sh runs clean, pip install -e . works, jax.devices() returns [CpuDevice(id=0)], mypy passes

### US-004: Implement FieldState dataclass [x]
- Created src/field/field.py with FieldState as @flax.struct.dataclass
- FieldState contains `values: jnp.ndarray` with shape (H, W, C)
- Implemented `create_field(height, width, channels)` factory function returning zero-initialized FieldState
- All TestFieldState tests pass (2/2)
- Typecheck passes

### US-005: Implement field dynamics (diffusion + decay) [x]
- Created src/field/dynamics.py with three functions: diffuse(), decay(), step_field()
- diffuse() uses 3x3 Gaussian kernel (1,2,1/2,4,2/1,2,1 normalized to sum=1), edge-padded, blended by rate
- decay() multiplies field values by (1 - rate)
- step_field() chains diffuse then decay
- All functions JIT-compatible (static loop over 3x3 kernel unrolled at trace time)
- Used FieldState constructor instead of .replace() to satisfy mypy
- All 5 TestFieldDynamics tests pass
- Typecheck passes

### US-006: Implement field read/write operations [x]
- Created src/field/ops.py with two functions: write_local() and read_local()
- write_local(field, positions, values): uses jnp.ndarray.at[].add() to write values at agent (row, col) positions; shape (N, 2) positions, (N, C) values
- read_local(field, positions, radius): reads local field values; radius=0 returns (N, C) at exact positions, radius>0 returns flattened (2r+1)x(2r+1) neighborhood as (N, (2r+1)^2 * C)
- Out-of-bounds reads are clamped to field edges via jnp.clip
- Both functions are JIT-compatible (no Python control flow for radius>0 case; radius is a static int)
- All 4 TestFieldOps tests pass, all 11 field tests pass
- Typecheck passes

### US-007: Implement EnvState dataclass [x]
- Created src/environment/state.py with EnvState as @flax.struct.dataclass
- EnvState fields: agent_positions (num_agents, 2), food_positions (num_food, 2), food_collected (num_food,) bool, field_state (FieldState), step (scalar int), key (PRNG key)
- Implemented create_env_state(key, config) factory function that randomly places agents and food on the grid, initializes field to zeros
- All TestEnvState tests pass (1/1)
- Typecheck passes

### US-008: Implement environment reset [x]
- Created src/environment/env.py with `reset(key, config) -> EnvState`
- Used `jax.random.permutation` over flattened grid indices to guarantee non-overlapping agent positions
- Food positions are random via `jax.random.randint` (may overlap each other, which is fine)
- Field initialized to zeros via `create_field()`
- Added 2 extra tests: `test_reset_field_initialized_fresh` and `test_reset_food_not_collected`
- All 5 TestEnvReset tests pass, typecheck passes
- Files changed: src/environment/env.py (new), tests/test_env.py (added tests)

## Current Task
US-009: Implement environment step

## Decisions Made
- Using JAX/Flax/Optax stack (not PyTorch)
- Dataclasses + YAML for config (not Hydra)
- W&B for experiment tracking
- Field has 4 channels by default
- 8 agents, 20x20 grid as starting point
- Shared rewards (team-based)

## Files Changed
- src/__init__.py
- src/configs.py (fixed mypy errors: renamed field import, fixed to_dict, fixed AgentConfig construction)
- src/environment/__init__.py
- src/agents/__init__.py
- src/training/__init__.py
- src/field/__init__.py
- src/analysis/__init__.py
- configs/default.yaml
- scripts/setup.sh
- pyproject.toml (added types-PyYAML to dev deps)
- tests/*.py (test stubs)
- src/field/field.py (FieldState dataclass and create_field)
- src/field/dynamics.py (diffuse, decay, step_field)
- src/field/ops.py (read_local, write_local)
- src/environment/state.py (EnvState dataclass and create_env_state)

## Key Design Notes
- The FIELD is the key innovation (shared medium between agents)
- Field has its own dynamics (diffusion + decay)
- Agents read/write to field locally
- We test if field develops structure encoding collective knowledge
- Ablation test will show if field matters

## Notes for Future Tasks
- US-004 through US-006: Field implementation is critical — this is our novel contribution
- US-009: Environment step must update field each timestep
- US-022-024: Analysis is how we prove emergence — metrics must be meaningful
